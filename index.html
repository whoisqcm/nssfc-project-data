<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J8LMWL30RM"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-J8LMWL30RM');</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>国家社科基金立项数据库</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;background:#f5f7fa;color:#333;line-height:1.6}
.header{background:linear-gradient(135deg,#1a365d,#2a4a7f);color:#fff;padding:2rem;text-align:center}
.header h1{font-size:1.6rem;margin-bottom:.3rem}
.header p{opacity:.8;font-size:.9rem}
.stats{display:flex;gap:1rem;justify-content:center;margin-top:1rem;flex-wrap:wrap}
.stat{background:rgba(255,255,255,.15);border-radius:8px;padding:.5rem 1.2rem;text-align:center}
.stat .num{font-size:1.4rem;font-weight:700}
.stat .label{font-size:.75rem;opacity:.8}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.filters{background:#fff;border-radius:10px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;gap:.8rem;flex-wrap:wrap;align-items:flex-end}
.filter-group{display:flex;flex-direction:column;gap:.3rem;flex:1;min-width:180px}
.filter-group label{font-size:.8rem;font-weight:600;color:#555}
.filter-group select,.filter-group input{padding:.5rem .7rem;border:1px solid #ddd;border-radius:6px;font-size:.85rem;background:#fff}
.filter-group input{min-width:250px}
.btn{padding:.5rem 1.2rem;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .2s}
.btn-primary{background:#2a4a7f;color:#fff}
.btn-primary:hover{background:#1a365d}
.btn-secondary{background:#e2e8f0;color:#555}
.btn-secondary:hover{background:#cbd5e0}
.results-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;font-size:.85rem;color:#666}
.table-wrap{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead{background:#f8fafc;position:sticky;top:0}
th{padding:.7rem .6rem;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #e2e8f0;white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:#2a4a7f}
th .sort-icon{margin-left:4px;opacity:.4}
th.active .sort-icon{opacity:1}
td{padding:.55rem .6rem;border-bottom:1px solid #f0f0f0}
tr:hover td{background:#f8fafc}
.pagination{display:flex;justify-content:center;align-items:center;gap:.5rem;margin-top:1rem;padding:1rem}
.pagination button{padding:.4rem .8rem;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;font-size:.82rem}
.pagination button:hover:not(:disabled){background:#e2e8f0}
.pagination button:disabled{opacity:.4;cursor:default}
.pagination .current{background:#2a4a7f;color:#fff;border-color:#2a4a7f}
.loading{text-align:center;padding:3rem;color:#888}
.loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid #e2e8f0;border-top-color:#2a4a7f;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem;color:#999}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:4px;font-size:.75rem;font-weight:500}
.tag-major{background:#fef3c7;color:#92400e}
.tag-youth{background:#dbeafe;color:#1e40af}
.tag-general{background:#d1fae5;color:#065f46}
.tag-west{background:#fce7f3;color:#9d174d}
.tag-key{background:#fee2e2;color:#991b1b}
.tag-late{background:#e0e7ff;color:#3730a3}
.tag-other{background:#f3f4f6;color:#374151}
.footer{text-align:center;padding:2rem;color:#999;font-size:.8rem}
@media(max-width:768px){.filters{flex-direction:column}.filter-group{min-width:100%}table{font-size:.75rem}td,th{padding:.4rem}}
/* Auth overlay */
.auth-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a365d,#2a4a7f);display:flex;align-items:center;justify-content:center;z-index:9999}
.auth-box{background:#fff;border-radius:12px;padding:2.5rem;width:340px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.auth-box h2{font-size:1.2rem;color:#1a365d;margin-bottom:.3rem}
.auth-box p{font-size:.82rem;color:#888;margin-bottom:1.5rem}
.auth-box input{width:100%;padding:.6rem .8rem;border:1.5px solid #ddd;border-radius:6px;font-size:.9rem;text-align:center;letter-spacing:2px;outline:none;transition:border-color .2s}
.auth-box input:focus{border-color:#2a4a7f}
.auth-box .auth-btn{width:100%;margin-top:.8rem;padding:.6rem;background:#2a4a7f;color:#fff;border:none;border-radius:6px;font-size:.9rem;font-weight:600;cursor:pointer;transition:background .2s}
.auth-box .auth-btn:hover{background:#1a365d}
.auth-box .auth-err{color:#dc2626;font-size:.8rem;margin-top:.6rem;min-height:1.2rem}
/* Tabs */
.tabs{display:flex;gap:0;margin-bottom:1rem}
.tab-btn{padding:.6rem 1.5rem;border:none;background:#e2e8f0;color:#555;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s;border-radius:8px 8px 0 0}
.tab-btn:hover{background:#cbd5e0}
.tab-btn.active{background:#2a4a7f;color:#fff}
.tab-panel{display:none}
.tab-panel.active{display:block}
/* Recommend panel */
.rec-box{background:#fff;border-radius:10px;padding:1.5rem;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.rec-box h3{font-size:1rem;font-weight:600;color:#1a365d;margin-bottom:.8rem}
.rec-input-row{display:flex;gap:.8rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:1rem}
.rec-input-row .filter-group{flex:2;min-width:300px}
.rec-input-row .filter-group.disc-select{flex:1;min-width:200px}
.rec-input-row textarea{width:100%;padding:.5rem .7rem;border:1px solid #ddd;border-radius:6px;font-size:.85rem;resize:vertical;min-height:2.5rem;font-family:inherit}
.rec-results{margin-top:1rem}
.rec-card{background:#fff;border:1px solid #eee;border-radius:8px;padding:1rem;margin-bottom:.6rem;transition:border-color .2s}
.rec-card:hover{border-color:#2a4a7f}
.rec-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
.rec-card-title{font-size:.9rem;font-weight:600;color:#1a365d}
.rec-score{font-size:.8rem;font-weight:700;color:#fff;background:#2a4a7f;padding:.15rem .6rem;border-radius:12px}
.rec-card-meta{font-size:.78rem;color:#888;display:flex;gap:1rem;flex-wrap:wrap}
.rec-tokens{font-size:.78rem;color:#999;margin-top:.3rem}
.rec-tokens span{background:#f0f4ff;color:#2a4a7f;padding:.1rem .4rem;border-radius:3px;margin-right:.3rem;font-size:.75rem}
.disc-chips{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.8rem}
.disc-chip{padding:.25rem .6rem;border-radius:16px;font-size:.78rem;cursor:pointer;border:1.5px solid #ddd;background:#fff;transition:all .15s;user-select:none}
.disc-chip:hover{border-color:#2a4a7f;color:#2a4a7f}
.disc-chip.selected{background:#2a4a7f;color:#fff;border-color:#2a4a7f}
.rec-hint{font-size:.78rem;color:#999;margin-bottom:.5rem}
.rec-status{font-size:.82rem;color:#666;padding:.5rem 0}
</style>
</head>
<body>

<!-- Auth overlay -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>国社科立项数据库</h2>
    <p>请输入访问密码</p>
    <input type="password" id="authInput" placeholder="Access Code" autofocus>
    <button class="auth-btn" id="authBtn" onclick="checkAuth()">进入</button>
    <div class="auth-err" id="authErr"></div>
  </div>
</div>

<!-- Main content (hidden until auth) -->
<div id="mainContent" style="display:none">

<div class="header">
  <h1>国家社科基金立项数据库</h1>
  <p>National Social Science Fund of China - Approved Projects Database</p>
  <div class="stats">
    <div class="stat"><div class="num" id="totalCount">-</div><div class="label">总记录数</div></div>
    <div class="stat"><div class="num" id="discCount">-</div><div class="label">学科门类</div></div>
    <div class="stat"><div class="num" id="yearSpan">-</div><div class="label">年份跨度</div></div>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('search')">数据查询</button>
    <button class="tab-btn" onclick="switchTab('recommend')">标题撞车检索</button>
  </div>

  <!-- Tab 1: Search (original) -->
  <div class="tab-panel active" id="tabSearch">
    <div class="filters">
      <div class="filter-group">
        <label>学科分类</label>
        <select id="filterDisc"><option value="">全部学科</option></select>
      </div>
      <div class="filter-group">
        <label>项目类别</label>
        <select id="filterCat"><option value="">全部类别</option></select>
      </div>
      <div class="filter-group">
        <label>立项年份</label>
        <select id="filterYear"><option value="">全部年份</option></select>
      </div>
      <div class="filter-group">
        <label>关键词搜索</label>
        <input type="text" id="searchInput" placeholder="项目名称 / 负责人 / 单位">
      </div>
      <div style="display:flex;gap:.5rem;align-items:flex-end">
        <button class="btn btn-primary" onclick="applyFilters()">查询</button>
        <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
      </div>
    </div>

    <div class="results-bar">
      <span id="resultsInfo">加载中...</span>
      <span id="exportInfo"></span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-col="项目批准号" onclick="sortBy('项目批准号')">批准号 <span class="sort-icon">&#9650;</span></th>
            <th data-col="项目类别" onclick="sortBy('项目类别')">类别 <span class="sort-icon">&#9650;</span></th>
            <th data-col="学科分类" onclick="sortBy('学科分类')">学科 <span class="sort-icon">&#9650;</span></th>
            <th data-col="项目名称" onclick="sortBy('项目名称')">项目名称 <span class="sort-icon">&#9650;</span></th>
            <th data-col="项目负责人" onclick="sortBy('项目负责人')">负责人 <span class="sort-icon">&#9650;</span></th>
            <th data-col="工作单位" onclick="sortBy('工作单位')">单位 <span class="sort-icon">&#9650;</span></th>
            <th data-col="所在省区市" onclick="sortBy('所在省区市')">省区市 <span class="sort-icon">&#9650;</span></th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="7" class="loading"><div class="spinner"></div><br>正在加载数据...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Tab 2: Title Collision Check -->
  <div class="tab-panel" id="tabRecommend">
    <div class="rec-box">
      <h3>标题撞车检索</h3>
      <p class="rec-hint">输入您的课题标题，系统将基于 TF-IDF 文本相似度从已立项课题中检索最相似的标题，帮助您排查选题是否与已有项目撞车。请先选择至少一个学科范围。</p>

      <div style="margin-top:1rem">
        <label style="font-size:.8rem;font-weight:600;color:#555;display:block;margin-bottom:.4rem">选择学科范围（可多选）</label>
        <div class="disc-chips" id="recDiscChips"></div>
      </div>

      <div class="rec-input-row" style="margin-top:.8rem">
        <div class="filter-group" style="flex:3;min-width:350px">
          <label>输入课题标题</label>
          <input type="text" id="recTitleInput" placeholder="例：生成式人工智能对国际传播格局的影响研究" style="font-size:.9rem;padding:.6rem .8rem">
        </div>
        <div style="display:flex;gap:.5rem;align-items:flex-end">
          <button class="btn btn-primary" onclick="doRecommend()">检索</button>
          <button class="btn btn-secondary" onclick="clearRecommend()">清空</button>
        </div>
      </div>

      <div class="rec-status" id="recStatus"></div>
      <div class="rec-results" id="recResults"></div>
    </div>
  </div>

</div>

<div class="footer">
  数据来源：<a href="https://fz.people.com.cn/skygb/sk/index.php/index/seach/" target="_blank">全国哲学社会科学工作办公室</a>
  <br>Created by QCM &middot; Inspired by WY
  <br>For academic research purposes only
</div>

</div><!-- end mainContent -->

<script>
// Auth gate
const PASS_HASH = '0c5ef71a90c64518f66682ac9e56a6a240af79b16e5750aec1a9ea308d42876c';
const PBKDF2_ITERATIONS = 100000;
const _k = [51,49,81,50,55,122,50,57,51,53];
const DATA_KEY = String.fromCharCode(..._k);
const DATA_BASE = 'https://cdn.jsdelivr.net/gh/whoisqcm/nssfc-project-data@master/';

async function deriveAesKey(password, salt) {
  const km = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:PBKDF2_ITERATIONS, hash:'SHA-256'}, km, {name:'AES-CBC', length:256}, false, ['decrypt']);
}

async function decryptData(buf) {
  const d = new Uint8Array(buf);
  const key = await deriveAesKey(DATA_KEY, d.slice(0, 16));
  const dec = await crypto.subtle.decrypt({name:'AES-CBC', iv:d.slice(16, 32)}, key, d.slice(32));
  return new TextDecoder().decode(dec);
}

async function fetchJSON(url) {
  try { const r = await fetch(DATA_BASE + url + '.enc'); if (r.ok) return JSON.parse(await decryptData(await r.arrayBuffer())); } catch(e) {}
  try { const r = await fetch(url + '.enc'); if (r.ok) return JSON.parse(await decryptData(await r.arrayBuffer())); } catch(e) {}
  return (await fetch(url)).json();
}

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkAuth() {
  const input = document.getElementById('authInput').value.trim();
  if (!input) return;
  const hash = await sha256(input);
  if (hash === PASS_HASH) {
    sessionStorage.setItem('nssfc_auth', '1');
    showMain();
  } else {
    document.getElementById('authErr').textContent = '密码错误';
    document.getElementById('authInput').value = '';
    document.getElementById('authInput').focus();
  }
}

function showMain() {
  document.getElementById('authOverlay').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';
  initApp();
}

document.getElementById('authInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') checkAuth();
});

// Check session
if (sessionStorage.getItem('nssfc_auth') === '1') {
  document.addEventListener('DOMContentLoaded', () => showMain());
}
</script>

<script>
// ===== Tab switching =====
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', (tab === 'search' && i === 0) || (tab === 'recommend' && i === 1));
  });
  document.getElementById('tabSearch').classList.toggle('active', tab === 'search');
  document.getElementById('tabRecommend').classList.toggle('active', tab === 'recommend');
}

// ===== Search Tab (original code) =====
const PAGE_SIZE = 50;
let indexData = null;
let currentData = [];
let filteredData = [];
let currentPage = 1;
let sortCol = '';
let sortAsc = true;
const dataCache = {};

async function loadIndex() {
  indexData = await fetchJSON('data/index.json');
  document.getElementById('totalCount').textContent = indexData.total.toLocaleString();
  document.getElementById('discCount').textContent = Object.keys(indexData.disciplines).length;
  const years = indexData.years;
  document.getElementById('yearSpan').textContent = years[years.length - 1] + '-' + years[0];

  const discSelect = document.getElementById('filterDisc');
  Object.entries(indexData.disciplines)
    .sort((a, b) => b[1].count - a[1].count)
    .forEach(([name, info]) => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = `${name} (${info.count})`;
      discSelect.appendChild(opt);
    });

  const catSelect = document.getElementById('filterCat');
  indexData.categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    catSelect.appendChild(opt);
  });

  const yearSelect = document.getElementById('filterYear');
  indexData.years.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });
}

async function loadDiscipline(name) {
  if (dataCache[name]) return dataCache[name];
  const info = indexData.disciplines[name];
  if (!info) return [];
  const data = await fetchJSON('data/' + info.file);
  dataCache[name] = data;
  return data;
}

async function loadAllData() {
  const promises = Object.keys(indexData.disciplines).map(d => loadDiscipline(d));
  const results = await Promise.all(promises);
  return results.flat();
}

function getYear(record) {
  const t = record['立项时间'] || '';
  if (t.length >= 4) return t.substring(0, 4);
  const code = record['项目批准号'] || '';
  if (code.length >= 2) {
    const prefix = code.substring(0, 2);
    if (/^\d{2}$/.test(prefix)) {
      const yr = parseInt(prefix);
      return yr >= 91 ? String(1900 + yr) : String(2000 + yr);
    }
  }
  return '';
}

function getCategoryTag(cat) {
  const map = {
    '重大项目': 'tag-major',
    '青年项目': 'tag-youth',
    '一般项目': 'tag-general',
    '西部项目': 'tag-west',
    '重点项目': 'tag-key',
    '后期资助项目': 'tag-late',
    '年度项目': 'tag-general',
  };
  const cls = map[cat] || 'tag-other';
  return `<span class="tag ${cls}">${cat || '-'}</span>`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

async function applyFilters() {
  const disc = document.getElementById('filterDisc').value;
  const cat = document.getElementById('filterCat').value;
  const year = document.getElementById('filterYear').value;
  const keyword = document.getElementById('searchInput').value.trim().toLowerCase();

  document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div><br>正在加载数据...</td></tr>';

  let data;
  if (disc) {
    data = await loadDiscipline(disc);
  } else if (cat || year || keyword) {
    data = await loadAllData();
  } else {
    data = await loadAllData();
  }

  filteredData = data.filter(r => {
    if (cat && r['项目类别'] !== cat) return false;
    if (year && getYear(r) !== year) return false;
    if (keyword) {
      const text = [r['项目名称'], r['项目负责人'], r['工作单位'], r['项目批准号']].join(' ').toLowerCase();
      if (!text.includes(keyword)) return false;
    }
    return true;
  });

  currentPage = 1;
  sortCol = '';
  renderTable();
}

function resetFilters() {
  document.getElementById('filterDisc').value = '';
  document.getElementById('filterCat').value = '';
  document.getElementById('filterYear').value = '';
  document.getElementById('searchInput').value = '';
  filteredData = [];
  currentPage = 1;
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="empty">请选择筛选条件后点击"查询"</td></tr>';
  document.getElementById('resultsInfo').textContent = `共 ${indexData.total.toLocaleString()} 条记录，请筛选查看`;
  document.getElementById('pagination').innerHTML = '';
}

function sortBy(col) {
  if (sortCol === col) {
    sortAsc = !sortAsc;
  } else {
    sortCol = col;
    sortAsc = true;
  }
  document.querySelectorAll('th').forEach(th => th.classList.remove('active'));
  const activeTh = document.querySelector(`th[data-col="${col}"]`);
  if (activeTh) {
    activeTh.classList.add('active');
    activeTh.querySelector('.sort-icon').innerHTML = sortAsc ? '&#9650;' : '&#9660;';
  }
  filteredData.sort((a, b) => {
    const va = (a[col] || '').toString();
    const vb = (b[col] || '').toString();
    return sortAsc ? va.localeCompare(vb, 'zh') : vb.localeCompare(va, 'zh');
  });
  currentPage = 1;
  renderTable();
}

function renderTable() {
  const total = filteredData.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageData = filteredData.slice(start, start + PAGE_SIZE);

  document.getElementById('resultsInfo').textContent = `共 ${total.toLocaleString()} 条结果（第 ${start + 1}-${Math.min(start + PAGE_SIZE, total)} 条）`;

  const tbody = document.getElementById('tableBody');
  if (pageData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty">未找到匹配的记录</td></tr>';
    document.getElementById('pagination').innerHTML = '';
    return;
  }

  tbody.innerHTML = pageData.map(r => `<tr>
    <td>${escapeHtml(r['项目批准号'])}</td>
    <td>${getCategoryTag(r['项目类别'])}</td>
    <td>${escapeHtml(r['学科分类'])}</td>
    <td>${escapeHtml(r['项目名称'])}</td>
    <td>${escapeHtml(r['项目负责人'])}</td>
    <td>${escapeHtml(r['工作单位'])}</td>
    <td>${escapeHtml(r['所在省区市'])}</td>
  </tr>`).join('');

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  const pag = document.getElementById('pagination');
  if (totalPages <= 1) { pag.innerHTML = ''; return; }

  let html = '';
  html += `<button onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>首页</button>`;
  html += `<button onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;

  const range = 2;
  let start = Math.max(1, currentPage - range);
  let end = Math.min(totalPages, currentPage + range);
  if (start > 1) html += '<span>...</span>';
  for (let i = start; i <= end; i++) {
    html += `<button class="${i === currentPage ? 'current' : ''}" onclick="goPage(${i})">${i}</button>`;
  }
  if (end < totalPages) html += '<span>...</span>';

  html += `<button onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
  html += `<button onclick="goPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>末页</button>`;
  pag.innerHTML = html;
}

function goPage(page) {
  currentPage = page;
  renderTable();
  document.querySelector('.table-wrap').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') applyFilters();
});

// ===== Recommend Tab =====
let tfidfVocab = null;       // { term: [index, idf], ... }
let tfidfIndex = null;       // { disciplines: { name: { file, count, size } } }
const tfidfDataCache = {};   // discipline -> array of title records

let vocabMaxLen = 0;
const vocabByLen = {};  // length -> Set of terms

async function loadTfidfVocab() {
  if (tfidfVocab) return;
  tfidfVocab = await fetchJSON('data/tfidf_vocab.json');
  // Build lookup sets grouped by term length for fast matching
  for (const term of Object.keys(tfidfVocab)) {
    const len = term.length;
    if (len > vocabMaxLen) vocabMaxLen = len;
    if (!vocabByLen[len]) vocabByLen[len] = new Set();
    vocabByLen[len].add(term);
  }
}

async function loadTfidfIndex() {
  if (tfidfIndex) return;
  tfidfIndex = await fetchJSON('data/tfidf_index.json');
}

async function loadTfidfDisc(discName) {
  if (tfidfDataCache[discName]) return tfidfDataCache[discName];
  const info = tfidfIndex.disciplines[discName];
  if (!info) return [];
  const data = await fetchJSON('data/' + info.file);
  tfidfDataCache[discName] = data;
  return data;
}

// Forward maximum matching segmentation using vocabulary as dictionary
function segmentText(text) {
  const tokens = [];
  let i = 0;
  while (i < text.length) {
    let matched = false;
    // Try longest match first (descending length)
    const maxTry = Math.min(vocabMaxLen, text.length - i);
    for (let len = maxTry; len >= 2; len--) {
      const candidate = text.substring(i, i + len);
      if (vocabByLen[len] && vocabByLen[len].has(candidate)) {
        tokens.push(candidate);
        i += len;
        matched = true;
        break;
      }
    }
    if (!matched) {
      i++;
    }
  }
  return tokens;
}

// Build TF-IDF vector for query text
function buildQueryVector(text) {
  const tokens = segmentText(text);
  // Count term frequency
  const tf = {};
  for (const t of tokens) {
    tf[t] = (tf[t] || 0) + 1;
  }
  // Build TF-IDF vector
  const vec = {};
  let normSq = 0;
  for (const [term, count] of Object.entries(tf)) {
    if (!tfidfVocab[term]) continue;
    const [idx, idfVal] = tfidfVocab[term];
    const w = count * idfVal;
    vec[String(idx)] = w;
    normSq += w * w;
  }
  // L2 normalize
  if (normSq > 0) {
    const norm = Math.sqrt(normSq);
    for (const k of Object.keys(vec)) {
      vec[k] /= norm;
    }
  }
  return { vec, tokens };
}

// Cosine similarity between two sparse vectors
function cosineSim(vecA, vecB) {
  let dot = 0;
  for (const [k, v] of Object.entries(vecA)) {
    if (vecB[k]) {
      dot += v * vecB[k];
    }
  }
  return dot; // already L2-normalized
}

// Selected disciplines for recommendation
const selectedDiscs = new Set();

function initRecDiscChips() {
  const container = document.getElementById('recDiscChips');
  if (!tfidfIndex) return;

  const discs = Object.entries(tfidfIndex.disciplines)
    .filter(([, info]) => info.count >= 5)
    .sort((a, b) => b[1].count - a[1].count);

  container.innerHTML = discs.map(([name, info]) => {
    const sizeKB = Math.round(info.size / 1024);
    return `<span class="disc-chip" data-disc="${escapeHtml(name)}" onclick="toggleRecDisc(this)" title="${info.count} 条记录, ${sizeKB}KB">${escapeHtml(name)} (${info.count})</span>`;
  }).join('');
}

function toggleRecDisc(el) {
  const disc = el.getAttribute('data-disc');
  if (selectedDiscs.has(disc)) {
    selectedDiscs.delete(disc);
    el.classList.remove('selected');
  } else {
    selectedDiscs.add(disc);
    el.classList.add('selected');
  }
}

async function doRecommend() {
  const title = document.getElementById('recTitleInput').value.trim();
  const statusEl = document.getElementById('recStatus');
  const resultsEl = document.getElementById('recResults');

  if (!title) {
    statusEl.textContent = '请输入课题标题';
    resultsEl.innerHTML = '';
    return;
  }
  if (selectedDiscs.size === 0) {
    statusEl.textContent = '请至少选择一个学科范围';
    resultsEl.innerHTML = '';
    return;
  }

  statusEl.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;vertical-align:middle;margin-right:.5rem"></div>正在加载模型和检索相似课题...';
  resultsEl.innerHTML = '';

  // Ensure vocab is loaded
  await loadTfidfVocab();

  // Build query vector
  const { vec: queryVec, tokens: queryTokens } = buildQueryVector(title);

  if (Object.keys(queryVec).length === 0) {
    statusEl.textContent = '未能从标题中提取有效词汇，请尝试更详细的标题';
    return;
  }

  // Load selected discipline data
  const discNames = Array.from(selectedDiscs);
  statusEl.innerHTML = `<div class="spinner" style="width:20px;height:20px;border-width:2px;vertical-align:middle;margin-right:.5rem"></div>正在加载 ${discNames.length} 个学科的数据...`;

  const allTitles = [];
  const discResults = await Promise.all(discNames.map(disc => loadTfidfDisc(disc).then(data => ({ disc, data }))));
  for (const { disc, data } of discResults) {
    for (const item of data) {
      allTitles.push({ ...item, d: disc });
    }
  }

  statusEl.innerHTML = `<div class="spinner" style="width:20px;height:20px;border-width:2px;vertical-align:middle;margin-right:.5rem"></div>正在检索 ${allTitles.length.toLocaleString()} 个已立项课题...`;

  // Compute similarities (defer to avoid blocking UI)
  await new Promise(r => setTimeout(r, 50));

  const scored = [];
  for (const item of allTitles) {
    const sim = cosineSim(queryVec, item.v);
    if (sim > 0.05) {
      scored.push({ ...item, score: sim });
    }
  }

  scored.sort((a, b) => b.score - a.score);
  const topN = scored.slice(0, 50);

  // Display results
  statusEl.textContent = `在 ${allTitles.length.toLocaleString()} 个已立项课题中找到 ${scored.length} 个相似项，显示前 ${topN.length} 条`;

  if (topN.length === 0) {
    resultsEl.innerHTML = '<div class="empty">未找到相似课题，您的选题与已立项课题重复度较低</div>';
    return;
  }

  // Show matched query tokens
  const tokensHtml = `<div class="rec-tokens" style="margin-bottom:1rem">查询分词结果：${queryTokens.map(t => `<span>${escapeHtml(t)}</span>`).join('')}</div>`;

  resultsEl.innerHTML = tokensHtml + topN.map((item, i) => `
    <div class="rec-card">
      <div class="rec-card-header">
        <div class="rec-card-title">${i + 1}. ${escapeHtml(item.t)}</div>
        <div class="rec-score">${(item.score * 100).toFixed(1)}%</div>
      </div>
      <div class="rec-card-meta">
        <span>${getCategoryTag(item.c)}</span>
        <span>${escapeHtml(item.d)}</span>
        <span>${item.y || '-'}</span>
      </div>
    </div>
  `).join('');
}

function clearRecommend() {
  document.getElementById('recTitleInput').value = '';
  document.getElementById('recStatus').textContent = '';
  document.getElementById('recResults').innerHTML = '';
}

document.getElementById('recTitleInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doRecommend();
});

// ===== Init =====
async function initApp() {
  await loadIndex();
  document.getElementById('resultsInfo').textContent = `共 ${indexData.total.toLocaleString()} 条记录，请筛选查看`;
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="empty">请选择筛选条件后点击"查询"</td></tr>';

  // Init recommend tab
  await loadTfidfIndex();
  initRecDiscChips();
}
</script>

</body>
</html>
